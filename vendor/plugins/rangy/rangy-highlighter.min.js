/**
 * Highlighter module for Rangy, a cross-browser JavaScript range and selection library
 * http://code.google.com/p/rangy/
 *
 * Depends on Rangy core, TextRange and CssClassApplier modules.
 *
 * Copyright 2013, Tim Down
 * Licensed under the MIT license.
 * Version: 1.3alpha.755
 * Build date: 29 January 2013
 */
rangy.createModule("Highlighter",function(a,b){function e(a,b){return a.characterRange.start-b.characterRange.start}function i(a,b){this.type=a,this.converterCreator=b}function j(a,b){h[a]=new i(a,b)}function k(a){var b=h[a];if(b instanceof i)return b.create();throw new Error("Highlighter type '"+a+"' is not valid")}function l(a,b){this.start=a,this.end=b}function n(a,b,c,d,e){e?(this.id=e,g=Math.max(g,e+1)):this.id=g++,this.characterRange=b,this.doc=a,this.classApplier=c,this.converter=d,this.applied=!1}function o(a,b){b=b||"textContent",this.doc=a||document,this.classAppliers={},this.highlights=[],this.converter=k(b)}a.requireModules(["CssClassApplier"]);var c=a.dom,d=c.arrayContains,f=[].forEach?function(a,b){a.forEach(b)}:function(a,b){for(var c=0,d=a.length;c<d;++c)b(a[c])},g=1,h={};i.prototype.create=function(){var a=this.converterCreator();return a.type=this.type,a},a.registerHighlighterType=j,l.prototype={intersects:function(a){return this.start<a.end&&this.end>a.start},union:function(a){return new l(Math.min(this.start,a.start),Math.max(this.end,a.end))},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},l.fromCharacterRange=function(a){return new l(a.start,a.end)};var m={rangeToCharacterRange:function(a){var b=a.cloneRange();b.selectNodeContents(a.getDocument().body),b.setEnd(a.startContainer,a.startOffset);var c=b.toString().length;return new l(c,c+a.toString().length)},characterRangeToRange:function(b,c){var d=0,e=a.createRange(b),f=b.body;e.setStart(f,0),e.collapse(!0);var g=[f],h,i=!1,j=!1;while(!j&&(h=g.pop()))if(h.nodeType==3){var k=d+h.length;!i&&c.start>=d&&c.start<=k&&(e.setStart(h,c.start-d),i=!0),i&&c.end>=d&&c.end<=k&&(e.setEnd(h,c.end-d),j=!0),d=k}else{var l=h.childNodes.length;while(l--)g.push(h.childNodes[l])}return e},serializeSelection:function(a){var b=a.getAllRanges(),c=b.length,d=[],e=c==1&&a.isBackward();for(var f=0,g=b.length;f<g;++f)d[f]={characterRange:this.rangeToCharacterRange(b[f]),backward:e};return d},restoreSelection:function(a,b){a.removeAllRanges();var c=a.win.document;for(var d=0,e=b.length,f,g,h;d<e;++d)g=b[d],h=g.characterRange,f=this.characterRangeToRange(c,g.characterRange),a.addRange(f,g.backward)}};j("textContent",function(){return m}),j("TextRange",function(){var b;return function(){if(!b){var c=a.modules.TextRange;if(!c)throw new Error("TextRange module is missing.");if(!c.supported)throw new Error("TextRange module is present but not supported.");b={rangeToCharacterRange:function(a){return l.fromCharacterRange(a.toCharacterRange())},characterRangeToRange:function(b,c){var d=a.createRange(b);return d.selectCharacters(b.body,c.start,c.end),d},serializeSelection:function(a){return a.saveCharacterRanges()},restoreSelection:function(a,b){a.restoreCharacterRanges(a.win.document.body,b)}}}return b}}()),n.prototype={getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange)},fromRange:function(a){this.characterRange=this.converter.rangeToCharacterRange(a)},containsElement:function(a){return this.getRange().containsNodeContents(a.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.cssClass+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},o.prototype={addClassApplier:function(a){this.classAppliers[a.cssClass]=a},getHighlightForElement:function(a){var b=this.highlights;for(var c=0,d=b.length;c<d;++c)if(b[c].containsElement(a))return b[c];return null},removeHighlights:function(a){for(var b=0,c=this.highlights.length,e;b<c;++b)e=this.highlights[b],d(a,e)&&(e.unapply(),this.highlights.splice(b--,1))},getIntersectingHighlights:function(b){var c=[],e=this.highlights,g=this.converter;return a.noMutation(function(){f(b,function(a){var b=g.rangeToCharacterRange(a);f(e,function(a){b.intersects(a.characterRange)&&!d(c,a)&&c.push(a)})})}),c},highlightSelection:function(b,c){var d,e,g,h=this.converter;c=c||a.getSelection();var i=this.classAppliers[b],j=this.highlights,k=this.doc,m=k.body;if(!i)throw new Error("No class applier found for class '"+b+"'");var o=h.serializeSelection(c),p=[];f(o,function(a){p.push(l.fromCharacterRange(a.characterRange))});var q=[],r,s,t;for(d=0,g=p.length;d<g;++d){r=p[d],t=!1;for(e=0;e<j.length;++e)s=j[e].characterRange,s.intersects(r)&&(q.push(j[e]),j[e]=new n(k,s.union(r),i,h));t||j.push(new n(k,r,i,h))}return f(q,function(a){a.unapply()}),f(j,function(a){a.applied||a.apply()}),h.restoreSelection(c,o),j},unhighlightSelection:function(b){b=b||a.getSelection();var c=this.getIntersectingHighlights(b.getAllRanges());this.removeHighlights(c),b.removeAllRanges()},selectionOverlapsHighlight:function(b){return b=b||a.getSelection(),this.getIntersectingHighlights(b.getAllRanges()).length>0},serialize:function(){var a=this.highlights;a.sort(e);var b=["type:"+this.converter.type];return f(a,function(a){var c=a.characterRange;b.push([c.start,c.end,a.id,a.classApplier.cssClass].join("$"))}),b.join("|")},deserialize:function(a){var b=a.split("|"),c=[],d=b[0],e,f,g,h=!1;if(!d||!(e=/^type:(\w+)$/.exec(d)))throw new Error("Serialized highlights are invalid.");f=e[1],f!=this.converter.type&&(g=k(f),h=!0),b.shift();for(var i=b.length,j,m,o,p;i-->0;)j=b[i].split("$"),p=new l(+j[0],+j[1]),h&&(p=this.converter.rangeToCharacterRange(g.characterRangeToRange(this.doc,p))),m=this.classAppliers[j[3]],o=new n(this.doc,p,m,this.converter,j[2]),o.apply(),c.push(o);this.highlights=c}},a.Highlighter=o,a.createHighlighter=function(a,b){return new o(a,b)}})